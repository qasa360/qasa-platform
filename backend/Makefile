# QASA Backend Makefile
# Simplified commands for Docker-based development

.PHONY: help build-stack up down logs clean clean-migrations fix-migrations-permissions migrate-reset migrate-init migrate-status migrate-sync seed

# Default target
help: ## Show this help message
	@echo "QASA Backend - Available Commands:"
	@echo "=================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

# Main command
build-stack: ## Build and start the development stack
	@echo "ðŸ§¹ Cleaning up existing containers..."
	@docker-compose down --remove-orphans 2>/dev/null || true
	@echo "ðŸš€ Building and starting QASA Backend..."
	@docker-compose up --build

# Essential commands
up: ## Start the development environment
	@echo "ðŸš€ Starting QASA Backend..."
	@docker-compose up

down: ## Stop and remove all containers
	@echo "ðŸ›‘ Stopping all containers..."
	@docker-compose down

logs: ## Show logs from backend
	@echo "ðŸ“‹ Showing backend logs..."
	@docker-compose logs -f qasa-backend

clean: ## Clean up containers, images, and volumes
	@echo "ðŸ§¹ Cleaning up Docker resources..."
	@docker-compose down --volumes --remove-orphans
	@docker system prune -f
	@echo "âœ… Cleanup completed"

migrate: ## Run Prisma migrations inside the backend container
	@echo "ðŸ“¦ Checking if backend container is running..."
	@if [ "$$(docker ps -q -f name=qasa-backend)" = "" ]; then \
		echo "âš ï¸  Backend container not running. Starting it first..."; \
		docker compose up -d qasa-backend; \
		sleep 5; \
	fi
	@echo "ðŸ—ï¸  Running Prisma migrations..."
	@docker compose exec qasa-backend npx prisma migrate dev --name "auto_migration"
	@echo "ðŸ”§ Fixing migrations permissions..."
	@sudo chown -R $$(id -u):$$(id -g) prisma/migrations 2>/dev/null || true
	@echo "âœ… Migration completed successfully!"

db-seed: ## Run Prisma migrations inside the backend container
	@echo "âœ… Migration completed successfully!"
	@echo "ðŸ—ï¸  Running Prisma seed..."
	@docker compose exec qasa-backend npm run prisma:seed

debug: ## Start backend in debug mode (port 9229 exposed for remote debugging)
	@echo "ðŸ› Starting backend in debug mode..."
	@docker-compose -f docker-compose.yml -f docker-compose.debug.yml up --build qasa-backend
	@echo "âœ… Debug mode active on port 9229. Attach your IDE debugger."

clean-migrations: ## Remove all Prisma migrations and fix permissions
	@echo "ðŸ—‘ï¸  Removing all migrations..."
	@sudo rm -rf prisma/migrations
	@mkdir -p prisma/migrations
	@sudo chown -R $$(id -u):$$(id -g) prisma/migrations
	@echo "âœ… Migrations cleaned and permissions fixed!"

fix-migrations-permissions: ## Fix ownership of migrations folder to current user
	@echo "ðŸ”§ Fixing migrations permissions..."
	@sudo chown -R $$(id -u):$$(id -g) prisma/migrations 2>/dev/null || true
	@echo "âœ… Permissions fixed!"

migrate-reset: ## Reset database and all migrations (WARNING: deletes all data)
	@echo "âš ï¸  WARNING: This will delete all data in the database!"
	@echo "ðŸ“¦ Checking if backend container is running..."
	@if [ "$$(docker ps -q -f name=qasa-backend)" = "" ]; then \
		echo "âš ï¸  Backend container not running. Starting it first..."; \
		docker compose up -d qasa-backend; \
		sleep 5; \
	fi
	@echo "ðŸ”„ Resetting database and migrations..."
	@docker compose exec -T qasa-backend npx prisma migrate reset --force --skip-seed
	@echo "ðŸ”§ Fixing migrations permissions..."
	@sudo chown -R $$(id -u):$$(id -g) prisma/migrations 2>/dev/null || true
	@echo "âœ… Database reset completed!"

migrate-init: clean-migrations migrate-reset ## Clean migrations, reset DB, and create initial migration
	@echo "ðŸ“¦ Checking if backend container is running..."
	@if [ "$$(docker ps -q -f name=qasa-backend)" = "" ]; then \
		echo "âš ï¸  Backend container not running. Starting it first..."; \
		docker compose up -d qasa-backend; \
		sleep 5; \
	fi
	@echo "ðŸ—ï¸  Creating initial migration..."
	@docker compose exec -T qasa-backend npx prisma migrate dev --name init
	@echo "ðŸ”§ Fixing migrations permissions..."
	@sudo chown -R $$(id -u):$$(id -g) prisma/migrations 2>/dev/null || true
	@echo "âœ… Initial migration created successfully!"

migrate-status: ## Check migration status without applying changes
	@echo "ðŸ“¦ Checking if backend container is running..."
	@if [ "$$(docker ps -q -f name=qasa-backend)" = "" ]; then \
		echo "âš ï¸  Backend container not running. Starting it first..."; \
		docker compose up -d qasa-backend; \
		sleep 5; \
	fi
	@echo "ðŸ“Š Checking migration status..."
	@docker compose exec -T qasa-backend npx prisma migrate status

create-default-template: ## Create default audit template
	@echo "ðŸ“¦ Checking if backend container is running..."
	@if [ "$$(docker ps -q -f name=qasa-backend)" = "" ]; then \
		echo "âš ï¸  Backend container not running. Starting it first..."; \
		docker compose up -d qasa-backend; \
		sleep 5; \
	fi
	@echo "ðŸ“ Creating default audit template..."
	@docker compose exec qasa-backend npx ts-node scripts/create-default-template.ts
	@echo "âœ… Default template created"

migrate-sync: ## Sync migrations when DB and local files are out of sync (PRODUCTION-SAFE)
	@echo "âš ï¸  This will sync migrations without resetting the database"
	@echo "ðŸ“¦ Checking if backend container is running..."
	@if [ "$$(docker ps -q -f name=qasa-backend)" = "" ]; then \
		echo "âš ï¸  Backend container not running. Starting it first..."; \
		docker compose up -d qasa-backend; \
		sleep 5; \
	fi
	@echo "ðŸ” Checking what differences exist..."
	@docker compose exec -T qasa-backend npx prisma migrate diff \
		--from-schema-datasource prisma/schema.prisma \
		--to-schema-datamodel prisma/schema.prisma \
		--script > /tmp/migration_diff.sql || true
	@if [ -s /tmp/migration_diff.sql ]; then \
		echo "ðŸ“ Differences found. Creating sync migration..."; \
		docker compose exec -T qasa-backend npx prisma migrate dev --name sync_missing_changes; \
	else \
		echo "âœ… No differences found. Database is in sync."; \
	fi
	@echo "ðŸ”§ Fixing migrations permissions..."
	@sudo chown -R $$(id -u):$$(id -g) prisma/migrations 2>/dev/null || true
	@echo "âœ… Sync completed!"
