# QASA Backend Makefile
# Simplified commands for Docker-based development

.PHONY: help build-stack up down logs clean

# Default target
help: ## Show this help message
	@echo "QASA Backend - Available Commands:"
	@echo "=================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

# Main command
build-stack: ## Build and start the development stack
	@echo "ğŸ§¹ Cleaning up existing containers..."
	@docker-compose down --remove-orphans 2>/dev/null || true
	@echo "ğŸš€ Building and starting QASA Backend..."
	@docker-compose up --build

# Essential commands
up: ## Start the development environment
	@echo "ğŸš€ Starting QASA Backend..."
	@docker-compose up

down: ## Stop and remove all containers
	@echo "ğŸ›‘ Stopping all containers..."
	@docker-compose down

logs: ## Show logs from backend
	@echo "ğŸ“‹ Showing backend logs..."
	@docker-compose logs -f qasa-backend

clean: ## Clean up containers, images, and volumes
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	@docker-compose down --volumes --remove-orphans
	@docker system prune -f
	@echo "âœ… Cleanup completed"

migrate: ## Run Prisma migrations inside the backend container
	@echo "ğŸ“¦ Checking if backend container is running..."
	@if [ "$$(docker ps -q -f name=qasa-backend)" = "" ]; then \
		echo "âš ï¸  Backend container not running. Starting it first..."; \
		docker compose up -d qasa-backend; \
		sleep 5; \
	fi
	@echo "ğŸ—ï¸  Running Prisma migrations..."
	@docker compose exec qasa-backend npx prisma migrate dev --name "auto_migration"
	@echo "âœ… Migration completed successfully!"

debug: ## Start backend in debug mode (port 9229 exposed for remote debugging)
	@echo "ğŸ› Starting backend in debug mode..."
	@docker-compose -f docker-compose.yml -f docker-compose.debug.yml up --build qasa-backend
	@echo "âœ… Debug mode active on port 9229. Attach your IDE debugger."
